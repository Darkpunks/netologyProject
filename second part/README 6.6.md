__________________________________________________________________________
Домашнее задание к занятию "6.6. Troubleshooting"
__________________________________________________________________________

Задача 1
__________________________________________________________________________

Перед выполнением задания ознакомьтесь с документацией по администрированию MongoDB.

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её нужно прервать.

Вы как инженер поддержки решили произвести данную операцию:

напишите список операций, которые вы будете производить для остановки запроса пользователя
предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB


ОТВЕТ:

1) Найти операцию командой: db.currentOp()
2) Использовать команду: db.killOp() для завершения операции. 

3) Решение проблемы с долгими (зависающими) запросами в MongoDB путем постройки\перестройки соответсвующего индекса или  использование параметра maxTimeMS() для CRUD запросов в MongoDB


__________________________________________________________________________
Задача 2
__________________________________________________________________________

Перед выполнением задания познакомьтесь с документацией по Redis latency troobleshooting.

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и увеличивается пропорционально количеству реплик сервиса.

При масштабировании сервиса до N реплик вы увидели, что:

сначала рост отношения записанных значений к истекшим
Redis блокирует операции записи
Как вы думаете, в чем может быть проблема?


ОТВЕТ:

Redis удаляет ключи с истекшим сроком действия двумя способами:

1)  "ленивый"  (lazy) способ - просроченные записи запрашиваются командой


2) "активный" (active) способ - повторяется каждые 100 миллисекунд и проводит записи в состояние устаревшие, затем данные записи исключаются.

ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP по умолчанию имеет значение 20, таким образом за раз можно пометить и очистить около 200 устаревших записей. Процесс проверки зациклится и мы ощутим задержки, а потом и вовсе не будут приниматься данные на запись, если появятся истекшие записи более 25% по отношению ко всем. В данном случае как раз так и получается. Такой подход необходим, чтобы не использовать слишком много памяти для ключей, срок действия которых уже истек.

__________________________________________________________________________
Задача 3
__________________________________________________________________________

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы, пользователи начали жаловаться на ошибки вида:

InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения данной проблемы вы можете предложить?


ОТВЕТ:

1) Можно попробовать увеличить значени mysql 
```
connect_timeout 
max_allowed_packet
net_buffer_length 
innodb_force_recovery
```
2) Может быть OOM Killer, который убивает процессы в системе, вполне мог убить процесс mysql прямо посередине критичного изменения файлов БД.

3) похожие проблемы могут наблюдаться при подсовывании двоичных файлов баз от более свежей версии mysql

__________________________________________________________________________
Задача 4
__________________________________________________________________________
Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с большим объемом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

postmaster invoked oom-killer

Как вы думаете, что происходит?

Как бы вы решили данную проблему?


ОТВЕТ: ОС, чтобы предотвартить падение всей системы, завершает процессы утилизирующие память так как не хватает ресурсом Оперативки (RAM), следовательно, увеличить оперативку (RAM) или если нету возможности увеличить ресурсы, то выставить ограничение в настройках PG на использование ресурсов хоста
